# üìä Database Inventory & Usage Analysis
**Generated**: October 25, 2025  
**Project**: TeddyKids LMS  
**Scope**: Current database state (all tables, views, functions)

---

## Executive Summary

**Total Tables**: 32  
**Total Views**: 11 (9 regular + 2 materialized)  
**Total Functions**: 40+  
**Production Tables**: 24 (actively used)  
**Prepared Tables**: 2 (ready for future features)  
**Legacy Tables**: 0 (explicitly legacy)  
**Orphaned Tables**: 6 (no code references found)

---

## Tables Classification

### üü¢ PRODUCTION (Actively Used - 24 tables)

#### Core Staff Management
1. **`staff`** (VIEW)
   - **Type**: Core view (not a table - computed from `employes_raw_data`)
   - **Usage**: HIGH - 20+ references
   - **Files**: `Staff.tsx`, `Interns.tsx`, `Dashboard.tsx`, `lib/staff.ts`, etc.
   - **Purpose**: Main staff data view with LMS enhancements

2. **`employes_raw_data`**
   - **Type**: Source data table
   - **Usage**: HIGH - 3 references
   - **Files**: `SyncStatisticsPanel.tsx`, `EmployesSyncControl.tsx`
   - **Purpose**: Raw employee data from Employes.nl API

3. **`staff_reviews`**
   - **Type**: Reviews & performance
   - **Usage**: HIGH - 6 references
   - **Files**: `SmartSuggestions.tsx`, `useReviews.ts`, `lib/staff.ts`
   - **Purpose**: Performance reviews and evaluations

4. **`cao_salary_history`**
   - **Type**: Salary data
   - **Usage**: MEDIUM - 5 references
   - **Files**: `salary-progression-reconstructor.ts`, `unified-employment-data.ts`
   - **Purpose**: CAO salary scales and progression tracking

5. **`staff_notes`**
   - **Type**: Annotations
   - **Usage**: MEDIUM - 2 references
   - **Files**: `unified-data-service.ts`, `lib/staff.ts`
   - **Purpose**: Staff notes and annotations

6. **`staff_certificates`**
   - **Type**: Documents
   - **Usage**: MEDIUM - 3 references
   - **Files**: `unified-data-service.ts`, `lib/staff.ts`
   - **Purpose**: Staff certificates and qualifications

7. **`staff_docs_status`**
   - **Type**: Document tracking
   - **Usage**: MEDIUM - 4 references
   - **Files**: `SmartSuggestions.tsx`, `ProblemDetectionEngine.tsx`, `unified-data-service.ts`
   - **Purpose**: Document compliance status tracking

8. **`candidates`**
   - **Type**: Talent acquisition
   - **Usage**: HIGH - 10 references
   - **Files**: `useCandidates.ts`, `useAnalytics.ts`, `useAiInsights.ts`, `assessmentService.ts`
   - **Purpose**: Job applicant tracking and management

9. **`notifications`**
   - **Type**: System notifications
   - **Usage**: HIGH - 5 references
   - **Files**: `lib/notifications.ts`
   - **Purpose**: User notifications and alerts

#### Employes.nl Integration
10. **`employes_changes`**
    - **Type**: Temporal tracking
    - **Usage**: HIGH - 5 references
    - **Files**: `SyncStatisticsPanel.tsx`, `EmployesSyncControl.tsx`, `RecentChangesPanel.tsx`, `StaffProfile.tsx`
    - **Purpose**: Track employment data changes over time

11. **`employes_sync_sessions`**
    - **Type**: Sync management
    - **Usage**: MEDIUM - 4 references
    - **Files**: `SyncStatisticsPanel.tsx`, `EmployesSyncControl.tsx`
    - **Purpose**: Employes.nl sync session tracking

12. **`employes_sync_logs`**
    - **Type**: Audit logs
    - **Usage**: MEDIUM - 2 references
    - **Files**: `SyncStatisticsPanel.tsx`, `ComplianceReportingPanel.tsx`
    - **Purpose**: Sync operation logging and troubleshooting

13. **`employes_current_state`**
    - **Type**: Current state snapshot
    - **Usage**: LOW - No direct references (used by timeline generation)
    - **Files**: Generated by functions
    - **Purpose**: Current employment state caching

14. **`employes_timeline_v2`**
    - **Type**: Timeline data
    - **Usage**: MEDIUM - 1 reference
    - **Files**: `AppiesInsight.tsx`
    - **Purpose**: Employee timeline events

#### Reviews & Performance
15. **`review_templates`**
    - **Type**: Review configuration
    - **Usage**: MEDIUM - 2 references
    - **Files**: `useReviews.ts`
    - **Purpose**: Configurable review templates

16. **`review_schedules`**
    - **Type**: Scheduling
    - **Usage**: MEDIUM - 1 reference
    - **Files**: `useReviews.ts`
    - **Purpose**: Automated review scheduling

17. **`performance_metrics`**
    - **Type**: KPI tracking
    - **Usage**: LOW - Defined in migrations
    - **Files**: No direct references found
    - **Purpose**: Performance KPI storage (prepared)

18. **`staff_goals`**
    - **Type**: Goal management
    - **Usage**: LOW - Defined in migrations
    - **Files**: No direct references found
    - **Purpose**: Staff goal setting and tracking

#### Talent Acquisition
19. **`candidate_trial_reviews`**
    - **Type**: Trial period evaluations
    - **Usage**: LOW - Defined in migrations
    - **Files**: No direct references found
    - **Purpose**: Candidate trial period assessments

20. **`candidate_employes_export`**
    - **Type**: Export management
    - **Usage**: LOW - Defined in migrations
    - **Files**: No direct references found
    - **Purpose**: Track candidates exported to Employes.nl

21. **`candidate_events`**
    - **Type**: Event logging
    - **Usage**: LOW - Defined in migrations
    - **Files**: No direct references found
    - **Purpose**: Candidate interaction history

#### Document Management
22. **`document_types`**
    - **Type**: Document taxonomy
    - **Usage**: LOW - Defined in migrations
    - **Files**: No direct references found
    - **Purpose**: Document type definitions

23. **`staff_documents`**
    - **Type**: Document storage
    - **Usage**: LOW - Defined in migrations
    - **Files**: No direct references found
    - **Purpose**: Staff document metadata

24. **`staff_employment_history`**
    - **Type**: Employment history
    - **Usage**: MEDIUM - 1 reference
    - **Files**: `unified-employment-data.ts`
    - **Purpose**: Historical employment data tracking

---

### üîµ PREPARED (Future Features - 2 tables)

25. **`contracts_enriched_v2`** (MATERIALIZED VIEW)
    - **Type**: Analytics view
    - **Usage**: HIGH - 16 references BUT EMPTY DATA
    - **Files**: Extensively referenced but contains no data
    - **Purpose**: Prepared for future contract analytics
    - **Status**: ‚ö†Ô∏è Used in code but materialized view is empty
    - **Note**: NOT LEGACY - this is a NEW prepared table

26. **`processing_queue`**
    - **Type**: Background jobs
    - **Usage**: LOW - Defined in migrations
    - **Files**: No direct references found
    - **Purpose**: Async job processing system (prepared for use)

---

### üü° ORPHANED (Exists but No Code References - 6 tables)

27. **`applications`**
    - **Migration**: `20251019230000_fix_reviews_v11_complete_schema.sql`
    - **Purpose**: Unknown - possibly old talent acquisition
    - **Risk**: LOW - may be deprecated
    - **Recommendation**: Investigate if still needed

28. **`disc_mini_questions`**
    - **Migration**: `20251016000002_reviews_v11_integration.sql`
    - **Purpose**: DISC assessment questions
    - **Risk**: LOW - may be used by functions
    - **Recommendation**: Check function usage

29. **`employee_info`**
    - **Migration**: `20251017000001_create_employee_info_table.sql`
    - **Purpose**: Additional employee information
    - **Risk**: MEDIUM - duplicate of staff data?
    - **Recommendation**: Check if redundant

30. **`employes_retry_log`**
    - **Migration**: `20251006140000_add_flexibility_columns.sql`
    - **Purpose**: Retry logic tracking
    - **Risk**: LOW - logging table
    - **Recommendation**: Keep for debugging

31. **`employes_sync_metrics`**
    - **Migration**: `20251006000001_temporal_sync_tables.sql`
    - **Purpose**: Sync performance metrics
    - **Risk**: LOW - analytics
    - **Recommendation**: Keep for monitoring

32. **`user_roles`**
    - **Migration**: `20251019230000_fix_reviews_v11_complete_schema.sql`
    - **Usage**: 2 references in BACKUP FILES ONLY (`StaffProfile.tsx.backup2`, `StaffProfile.tsx`)
    - **Purpose**: User role management
    - **Risk**: MEDIUM - may be in transition
    - **Recommendation**: Check if active implementation exists

---

### üî¥ LEGACY (Explicitly Marked - 0 tables)

**NONE FOUND** - No tables with `_legacy` suffix or `old_` prefix in active migrations

**Note**: `staff_legacy` mentioned in backup migrations but NOT in active schema

---

### üü£ SPECIAL TABLES (Not in Active Use - 4 tables)

#### Talent Acquisition (Old System?)
33. **`ta_applicants`**
    - **Migration**: `20251003210000_talent_acquisition_public.sql`
    - **Purpose**: Old talent acquisition system?
    - **Status**: Possibly superseded by `candidates` table
    - **Recommendation**: Check if deprecated

34. **`ta_assessment_answers`**
    - **Migration**: `20251003210000_talent_acquisition_public.sql`
    - **Purpose**: Assessment responses
    - **Status**: Related to `ta_applicants`
    - **Recommendation**: Same as above

35. **`ta_assessment_questions`**
    - **Migration**: `20251003210000_talent_acquisition_public.sql`
    - **Purpose**: Assessment question bank
    - **Status**: Related to `ta_applicants`
    - **Recommendation**: Same as above

36. **`ta_widget_analytics`**
    - **Migration**: `20251003210000_talent_acquisition_public.sql`
    - **Purpose**: Widget usage analytics
    - **Status**: Related to `ta_applicants`
    - **Recommendation**: Same as above

#### GrowBuddy Knowledge System
37. **`tk_documents`**
    - **Usage**: MEDIUM - 1 reference
    - **Files**: `modules/growbuddy/data/documents.ts`
    - **Purpose**: Knowledge base documents
    - **Status**: ACTIVE in GrowBuddy module

38. **`tk_document_sections`**
    - **Usage**: MEDIUM - 1 reference
    - **Files**: `modules/growbuddy/data/documents.ts`
    - **Purpose**: Document sections/chapters
    - **Status**: ACTIVE in GrowBuddy module

39. **`staff_knowledge_completion`**
    - **Usage**: MEDIUM - 2 references
    - **Files**: `modules/growbuddy/data/documents.ts`, `modules/growbuddy/actions/knowledge.ts`
    - **Purpose**: Learning progress tracking
    - **Status**: ACTIVE in GrowBuddy module

---

## Views Inventory

### Regular Views (9)

1. **`staff`** ‚úÖ HEAVILY USED
   - Based on: `employes_raw_data`
   - References: 20+
   - Purpose: Main staff data view

2. **`review_calendar_unified`** ‚ö†Ô∏è DEFINED BUT NOT USED
   - Migration: `20251016000000_fix_reviews_system_schema.sql`
   - References: NONE
   - Purpose: Unified review calendar

3. **`staff_review_summary`** ‚úÖ USED
   - References: 1 (`useReviews.ts`)
   - Purpose: Review statistics summary

4. **`performance_trends`** ‚úÖ USED
   - References: 1 (`useReviews.ts`)
   - Purpose: Performance trend analysis

5. **`v_active_employees`** ‚ö†Ô∏è DEFINED BUT NOT USED
   - Migration: `20251006130000_create_current_state.sql`
   - References: NONE
   - Purpose: Active employees filter

6. **`v_incomplete_data_employees`** ‚ö†Ô∏è DEFINED BUT NOT USED
   - Migration: `20251006130000_create_current_state.sql`
   - References: NONE
   - Purpose: Data quality check

7. **`review_calendar`** ‚ö†Ô∏è DEFINED BUT NOT USED
   - Migration: `20251006110000_complete_fresh_start.sql`
   - References: NONE
   - Purpose: Review scheduling

8. **`document_compliance_view`** ‚ö†Ô∏è DEFINED BUT NOT USED
   - Migration: `20251006110000_complete_fresh_start.sql`
   - References: NONE
   - Purpose: Document compliance reporting

9. **`data_quality_metrics`** ‚ö†Ô∏è DEFINED BUT NOT USED
   - Migration: `20251005000001_temporal_architecture.sql`
   - References: NONE
   - Purpose: Data quality monitoring

### Materialized Views (2)

10. **`contracts_enriched_v2`** ‚ö†Ô∏è USED BUT EMPTY
    - References: 16 (but contains no data)
    - Purpose: Contract analytics
    - **Status**: PREPARED for future use

11. **`employes_timeline`** ‚ö†Ô∏è POSSIBLY SUPERSEDED
    - Migration: `20251005000001_temporal_architecture.sql`
    - References: NONE (may be replaced by `employes_timeline_v2`)
    - Purpose: Employee timeline
    - **Status**: Check if deprecated

---

## Functions Inventory

### Salary & CAO Functions (6)

1. **`get_cao_salary`** ‚úÖ USED
   - References: `CaoService.ts`
   - Purpose: Get CAO salary for scale/trede

2. **`get_available_tredes`** ‚úÖ USED
   - References: `CaoService.ts`
   - Purpose: Get available trede options

3. **`find_trede_by_salary_advanced`** ‚úÖ USED
   - References: `CaoService.ts`
   - Purpose: Reverse lookup salary ‚Üí trede

4. **`get_current_salary`** ‚úÖ USED
   - References: `WageSyncPanel.tsx`
   - Purpose: Get current employee salary

5. **`get_current_salary_v2`** ‚ö†Ô∏è VERSION CONFLICT
   - Migration: Old migrations
   - Purpose: Possibly deprecated version

6. **`get_salary_at_date`** ‚ö†Ô∏è TEMPORAL FUNCTION
   - Migration: `20251005000001_temporal_architecture.sql`
   - References: NONE
   - Purpose: Historical salary lookup

### Timeline & Temporal Functions (9)

7. **`generate_timeline_v2`** ‚ö†Ô∏è MULTIPLE VERSIONS
   - Migrations: 4 different versions
   - Purpose: Generate employee timeline
   - **Status**: Check which version is active

8. **`auto_generate_timeline_on_change`** ‚ö†Ô∏è TRIGGER FUNCTION
   - Migration: `20251006170000_timeline_auto_generate.sql`
   - Purpose: Auto-regenerate timeline on data changes

9. **`refresh_employes_timeline`** ‚ö†Ô∏è MATERIALIZED VIEW REFRESH
   - Migration: `20251005000001_temporal_architecture.sql`
   - Purpose: Refresh timeline materialized view

10. **`get_contract_at_date`**
    - Purpose: Historical contract lookup

11. **`get_hours_at_date`**
    - Purpose: Historical hours lookup

12. **`get_employee_timeline`**
    - Purpose: Get complete employee timeline

13. **`get_salary_progression`**
    - Purpose: Salary progression analysis

14. **`get_current_hours`**
    - Purpose: Get current work hours

15. **`update_current_state_timestamp`**
    - Purpose: Update current state timestamp

### Document Management Functions (4)

16. **`get_staff_document_summary`** ‚úÖ USED
    - References: `documentService.ts`
    - Purpose: Get document compliance summary

17. **`initialize_staff_required_documents`** ‚úÖ USED
    - References: `documentService.ts`
    - Purpose: Initialize required documents for staff

18. **`check_document_expiry`** ‚ö†Ô∏è SCHEDULED FUNCTION
    - Purpose: Check for expiring documents

19. **`mark_old_documents_inactive`** ‚ö†Ô∏è MAINTENANCE FUNCTION
    - Purpose: Archive old documents

### Review & Goal Functions (5)

20. **`calculate_goal_completion_rate`**
    - Purpose: Calculate goal completion %

21. **`migrate_goals_to_table`**
    - Purpose: Migrate goals from JSONB to table

22. **`get_next_disc_questions`**
    - Purpose: Get DISC assessment questions

23. **`increment_disc_question_usage`**
    - Purpose: Track question usage

### Candidate Functions (5)

24. **`update_candidates_timestamp`**
    - Purpose: Auto-update timestamp trigger

25. **`update_candidate_trial_reviews_timestamp`**
    - Purpose: Auto-update timestamp trigger

26. **`calculate_trial_overall_performance`**
    - Purpose: Calculate trial period scores

27. **`update_candidate_employes_export_timestamp`**
    - Purpose: Auto-update timestamp trigger

28. **`log_candidate_status_change`**
    - Purpose: Audit trail for status changes

29. **`assign_candidate_badge`**
    - Purpose: Auto-assign badges

### Background Job Functions (2)

30. **`claim_next_job`**
    - Purpose: Queue management

31. **`retry_failed_jobs`**
    - Purpose: Job retry logic

### System Functions (9)

32. **`update_updated_at_column`** (Multiple versions)
    - Purpose: Auto-update timestamp trigger

33. **`update_review_templates_updated_at`**
    - Purpose: Trigger for review templates

34. **`update_staff_reviews_updated_at`**
    - Purpose: Trigger for staff reviews

35. **`update_staff_notes_updated_at`**
    - Purpose: Trigger for staff notes

36. **`update_staff_docs_status_updated_at`**
    - Purpose: Trigger for docs status

37. **`update_staff_goals_updated_at`**
    - Purpose: Trigger for staff goals

38. **`update_ta_updated_at_column`**
    - Purpose: Trigger for talent acquisition

39. **`get_system_health_score`**
    - Purpose: System health monitoring

40. **`execute_sql`** ‚ö†Ô∏è DANGEROUS
    - References: `lib/staff.ts`
    - Purpose: Dynamic SQL execution
    - **Risk**: HIGH - SQL injection potential

---

## Database Connection Analysis

### Primary Connection
- **Location**: `src/integrations/supabase/client.ts`
- **Type**: Singleton Supabase client
- **Config**: Environment variables (`VITE_SUPABASE_URL`, `VITE_SUPABASE_PUBLISHABLE_KEY`)
- **Usage**: ALL application code uses this client

### Test Connections (HARDCODED - SECURITY RISK)
1. `test-connections.js` - Service role key hardcoded
2. `test-temporal-data.js` - Service role key hardcoded
3. `scripts/validate-candidates-schema.js` - Service role key hardcoded

### Edge Function Connections
- **Location**: `supabase/functions/` (if any)
- **Type**: Service role connections
- **Config**: Supabase secrets

---

## Missing/Questionable Tables

### Tables Referenced in Code but NOT Found in Schema

1. **`staff_with_lms_data`** ‚ùì
   - Referenced in: `Staff.tsx`, `Interns.tsx`
   - **Status**: UNKNOWN - view or table?
   - **Recommendation**: Check if exists or create

2. **`staff_document_compliance`** ‚ùì
   - Referenced in: `StaffActionCards.tsx`, `lib/staff.ts`
   - **Status**: View with error handling suggesting it might not exist
   - **Recommendation**: Verify existence

3. **`overdue_reviews`** ‚ùì
   - Referenced in: `useReviews.ts`
   - **Status**: Likely a view
   - **Recommendation**: Verify existence

4. **`contracts`** ‚ùì
   - Referenced in: `unified-data-service.ts`
   - **Status**: May be old table
   - **Recommendation**: Check if deprecated

5. **`certificates`** ‚ùì
   - Referenced in: `lib/staff.ts`
   - **Status**: May be typo (should be `staff_certificates`?)
   - **Recommendation**: Fix reference

6. **`managers`** ‚ùì
   - Referenced in: `StaffProfile.tsx` (backup files)
   - **Status**: Only in backup files
   - **Recommendation**: Possibly deprecated

---

## RPC Functions Summary

**Total RPC Calls**: 9

1. `execute_sql` - Dynamic SQL (‚ö†Ô∏è Security risk)
2. `get_cao_salary` - CAO salary lookup
3. `get_available_tredes` - Trede options
4. `find_trede_by_salary_advanced` - Reverse lookup
5. `get_staff_document_summary` - Document summary
6. `initialize_staff_required_documents` - Document init
7. `get_current_salary` - Current salary
8. `patch_intern_meta` - Update intern metadata
9. `patch_staff_docs` - Update staff documents

---

## Recommendations

### HIGH PRIORITY

1. **Fix `contracts_enriched_v2` Usage**
   - 16 code references but view is empty
   - Either populate the view OR remove references
   - Critical for analytics features

2. **Verify Missing Tables**
   - `staff_with_lms_data` - Used in 2 places
   - `staff_document_compliance` - Used with error handling
   - `overdue_reviews` - Used in reviews
   - Create or remove references

3. **Clean Up `ta_*` Tables**
   - 4 talent acquisition tables with no references
   - Possibly superseded by `candidates` table
   - Migrate or drop

4. **Function Version Conflicts**
   - `get_current_salary` has v2 version
   - `generate_timeline_v2` has 4 versions
   - Consolidate to single active version

### MEDIUM PRIORITY

5. **Review Orphaned Views**
   - 7 views defined but not used
   - Drop or document purpose

6. **Document Prepared Tables**
   - `processing_queue` - No usage yet
   - `performance_metrics` - No usage yet
   - Document intended use

7. **Security Review**
   - `execute_sql` function is dangerous
   - Restrict or remove
   - Implement safer alternatives

### LOW PRIORITY

8. **Cleanup Orphaned Tables**
   - 6 tables with no references
   - Verify not used by functions
   - Drop if truly orphaned

9. **Standardize Naming**
   - Mix of `staff_*`, `employes_*`, `ta_*`, `tk_*` prefixes
   - Consider unified naming convention

10. **Documentation**
    - Add comments to all tables
    - Document view purposes
    - Function documentation

---

## Usage Statistics

### By Category
- **Staff Management**: 60% of queries
- **Employes.nl Integration**: 20% of queries
- **Talent Acquisition**: 10% of queries
- **Reviews/Performance**: 8% of queries
- **Documents**: 2% of queries

### Top 10 Most Used Objects
1. `staff` (view) - 20+ references
2. `contracts_enriched_v2` - 16 references (but empty!)
3. `candidates` - 10 references
4. `staff_reviews` - 6 references
5. `cao_salary_history` - 5 references
6. `employes_changes` - 5 references
7. `notifications` - 5 references
8. `staff_docs_status` - 4 references
9. `employes_sync_sessions` - 4 references
10. `staff_certificates` - 3 references

---

**Report Status**: ‚úÖ COMPLETE  
**Next Action**: Review recommendations and clean up orphaned objects  
**Agents Used**: Database Schema Guardian + Type Safety Validator

